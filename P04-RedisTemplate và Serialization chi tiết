## üìí **PH·∫¶N 4: RedisTemplate v√† Serialization chi ti·∫øt ‚Äì JSON, String, JDK, Custom Serializer**

### üéØ **M·ª•c ti√™u h·ªçc ph·∫ßn**

Sau ph·∫ßn n√†y, b·∫°n s·∫Ω:

1. Hi·ªÉu r√µ c√°ch Redis l∆∞u tr·ªØ d·ªØ li·ªáu trong Spring Boot qua **serializer**.
2. Ph√¢n bi·ªát c√°c lo·∫°i **serializer** (JDK, String, JSON, GenericJackson2Json).
3. Bi·∫øt c√°ch **t√πy ch·ªânh serializer** ƒë·ªÉ d·ªÖ debug v√† tƒÉng hi·ªáu nƒÉng.
4. Th·ª±c h√†nh: serialize/deserialize `User` object qua RedisTemplate.
5. Bi·∫øt debug khi l·ªói ‚ÄúCannot deserialize object‚Äù ho·∫∑c ‚ÄúUnreadable value‚Äù.

---

## üß† 1. RedisTemplate l√† g√¨?

`RedisTemplate` l√† **l·ªõp trung gian (client)** gi√∫p b·∫°n thao t√°c v·ªõi Redis trong Spring Boot:

* CRUD (Value, Hash, List, Set, SortedSet)
* Transaction
* Pub/Sub
* TTL

N√≥ **kh√¥ng l∆∞u d·ªØ li·ªáu tr·ª±c ti·∫øp** ‚Äî m√† **chuy·ªÉn ƒë·ªïi (serialize)** d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i qua Redis.
V√¨ Redis ch·ªâ l∆∞u **byte[]**, n√™n m·ªçi th·ª© (String, Object, JSON) ƒë·ªÅu ph·∫£i serialize.

---

## üîç 2. Ki·∫øn tr√∫c ho·∫°t ƒë·ªông c·ªßa RedisTemplate

```
[Object Java]
     ‚Üì  (Serializer)
[byte[] g·ª≠i ƒëi]
     ‚Üì
[Redis Server]
     ‚Üì
[byte[] tr·∫£ v·ªÅ]
     ‚Üì  (Deserializer)
[Object Java]
```

### üî∏ ASCII Flow:

```
   save(User)
     ‚îÇ
     ‚ñº
[RedisTemplate]
     ‚îÇ
     ‚ñº
[StringRedisSerializer] ‚Üí key = "user:1"
[Jackson2JsonSerializer] ‚Üí value = JSON(User)
     ‚îÇ
     ‚ñº
[Redis Server l∆∞u key:value]
```

---

## üß© 3. C√°c lo·∫°i Serializer ph·ªï bi·∫øn

| Serializer                             | M√¥ t·∫£                                           | ∆Øu ƒëi·ªÉm                 | Nh∆∞·ª£c ƒëi·ªÉm                                           |
| -------------------------------------- | ----------------------------------------------- | ----------------------- | ---------------------------------------------------- |
| **JdkSerializationRedisSerializer**    | D√πng c∆° ch·∫ø `Serializable` c·ªßa Java             | Kh√¥ng c·∫ßn th√™m th∆∞ vi·ªán | Kh√≥ debug (nh·ªã ph√¢n), kh√¥ng t∆∞∆°ng th√≠ch gi·ªØa version |
| **StringRedisSerializer**              | Chuy·ªÉn `String` ‚Üí `byte[]`                      | ƒê∆°n gi·∫£n, d·ªÖ ƒë·ªçc        | Ch·ªâ d√πng cho chu·ªói                                   |
| **GenericJackson2JsonRedisSerializer** | Serialize object ‚Üí JSON (t·ª± ƒë·ªông th√™m `@class`) | D·ªÖ debug, an to√†n       | T·ªën ch√∫t dung l∆∞·ª£ng do th√™m metadata                 |
| **Jackson2JsonRedisSerializer**        | Serialize nhanh, nh∆∞ng c·∫ßn khai b√°o type c·ª• th·ªÉ | Hi·ªáu nƒÉng cao           | D·ªÖ l·ªói n·∫øu kh√¥ng set type                            |

> üí° **Khuy·∫øn ngh·ªã:** D√πng `GenericJackson2JsonRedisSerializer` cho h·∫ßu h·∫øt c√°c use case ‚Äî v√¨ n√≥ l∆∞u JSON **v√† c√≥ metadata ƒë·ªÉ deserialize ch√≠nh x√°c**.

---

## ‚öôÔ∏è 4. C·∫•u h√¨nh RedisTemplate v·ªõi serializer chu·∫©n

```java
package com.example.redis.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.jsontype.BasicPolymorphicTypeValidator;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.*;

@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {

        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // ‚úÖ Key l√† chu·ªói d·ªÖ ƒë·ªçc
        template.setKeySerializer(new StringRedisSerializer());

        // ‚úÖ Value: JSON an to√†n (t·ª± th√™m @class metadata)
        ObjectMapper mapper = new ObjectMapper();
        mapper.activateDefaultTyping(
                BasicPolymorphicTypeValidator.builder().allowIfBaseType(Object.class).build(),
                ObjectMapper.DefaultTyping.EVERYTHING
        );

        GenericJackson2JsonRedisSerializer serializer =
                new GenericJackson2JsonRedisSerializer(mapper);

        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);

        template.afterPropertiesSet();
        return template;
    }
}
```

---

## üíæ 5. Demo: Serialize Object sang Redis

### üìÅ Model

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Product {
    private String id;
    private String name;
    private double price;
}
```

### üìÇ Service

```java
@Service
@RequiredArgsConstructor
public class ProductRedisService {

    private final RedisTemplate<String, Object> redisTemplate;
    private static final String PREFIX = "product:";

    public void save(Product product) {
        redisTemplate.opsForValue().set(PREFIX + product.getId(), product);
    }

    public Product findById(String id) {
        return (Product) redisTemplate.opsForValue().get(PREFIX + id);
    }
}
```

---

### üì° Controller

```java
@RestController
@RequestMapping("/products")
@RequiredArgsConstructor
public class ProductController {

    private final ProductRedisService service;

    @PostMapping
    public String save(@RequestBody Product product) {
        service.save(product);
        return "Saved product to Redis!";
    }

    @GetMapping("/{id}")
    public Product get(@PathVariable String id) {
        return service.findById(id);
    }
}
```

---

### üß™ Test v·ªõi curl

```bash
curl -X POST http://localhost:8080/products \
-H "Content-Type: application/json" \
-d '{"id":"101","name":"MacBook Air","price":999.99}'
```

```bash
curl http://localhost:8080/products/101
```

---

### üß© K·∫øt qu·∫£ trong Redis CLI

```bash
127.0.0.1:6379> keys *
"product:101"

127.0.0.1:6379> get product:101
"{\"@class\":\"com.example.redis.model.Product\",\"id\":\"101\",\"name\":\"MacBook Air\",\"price\":999.99}"
```

‚û°Ô∏è Redis l∆∞u JSON d·ªÖ ƒë·ªçc, c√≥ `@class` ‚Üí gi√∫p Spring Boot bi·∫øt class n√†o c·∫ßn deserialize khi ƒë·ªçc l·∫°i.

---

## üß™ 6. Tu·ª≥ ch·ªânh Serializer ri√™ng cho t·ª´ng lo·∫°i d·ªØ li·ªáu

B·∫°n c√≥ th·ªÉ t·∫°o nhi·ªÅu RedisTemplate kh√°c nhau cho t·ª´ng domain:

```java
@Bean
public RedisTemplate<String, String> stringTemplate(RedisConnectionFactory factory) {
    RedisTemplate<String, String> template = new RedisTemplate<>();
    template.setConnectionFactory(factory);
    template.setKeySerializer(new StringRedisSerializer());
    template.setValueSerializer(new StringRedisSerializer());
    return template;
}
```

Ho·∫∑c ri√™ng cho ki·ªÉu c·ª• th·ªÉ:

```java
@Bean
public RedisTemplate<String, Product> productTemplate(RedisConnectionFactory factory) {
    RedisTemplate<String, Product> template = new RedisTemplate<>();
    template.setConnectionFactory(factory);
    template.setKeySerializer(new StringRedisSerializer());
    template.setValueSerializer(new Jackson2JsonRedisSerializer<>(Product.class));
    return template;
}
```

---

## üß† 7. Khi n√†o d√πng Serializer n√†o?

| Use Case                                | Serializer khuy√™n d√πng               |
| --------------------------------------- | ------------------------------------ |
| Cache Object (User, Product...)         | `GenericJackson2JsonRedisSerializer` |
| L∆∞u chu·ªói ƒë∆°n gi·∫£n                      | `StringRedisSerializer`              |
| L∆∞u ki·ªÉu primitive (counter, flag)      | `StringRedisSerializer`              |
| Khi t·ªëc ƒë·ªô c·ª±c quan tr·ªçng, type c·ªë ƒë·ªãnh | `Jackson2JsonRedisSerializer<T>`     |
| Khi l∆∞u binary, object ph·ª©c t·∫°p         | `JdkSerializationRedisSerializer`    |

---

## üß© 8. Debug l·ªói th∆∞·ªùng g·∫∑p

| L·ªói                        | Nguy√™n nh√¢n                                | C√°ch x·ª≠ l√Ω                                                |
| -------------------------- | ------------------------------------------ | --------------------------------------------------------- |
| ‚ùå `Could not deserialize`  | Thay ƒë·ªïi class, kh√°c serializer            | X√≥a key c≈© ho·∫∑c d√πng `GenericJackson2JsonRedisSerializer` |
| ‚ùå Redis hi·ªÉn th·ªã nh·ªã ph√¢n  | D√πng JDK serializer                        | ƒê·ªïi sang JSON serializer                                  |
| ‚ùå `ClassNotFoundException` | Key ch·ª©a `@class` nh∆∞ng app thi·∫øu class ƒë√≥ | Ki·ªÉm tra package / version                                |
| ‚ùå ‚Äúnull return‚Äù            | Value b·ªã null ho·∫∑c serializer mismatch     | Ki·ªÉm tra key serializer                                   |

---

## üßÆ 9. B√†i t·∫≠p nh·ªè

**B√†i 1:**
T·∫°o `OrderRedisService` l∆∞u `Order` object (id, total, createdAt).
C·∫•u h√¨nh RedisTemplate ri√™ng v·ªõi `Jackson2JsonRedisSerializer<Order>`.

**B√†i 2:**
Th·ª≠ thay `GenericJackson2JsonRedisSerializer` b·∫±ng `JdkSerializationRedisSerializer`
‚Üí Quan s√°t s·ª± kh√°c bi·ªát khi xem d·ªØ li·ªáu trong `redis-cli`.

**B√†i 3:**
Th·ª≠ serialize object l·ªìng nhau (User ch·ª©a List<Order>) ‚Üí xem c√≥ deserialize l·∫°i ƒë∆∞·ª£c kh√¥ng.

---

## ‚ö†Ô∏è 10. Sai l·∫ßm ph·ªï bi·∫øn

| Sai l·∫ßm                               | H·∫≠u qu·∫£                                          |
| ------------------------------------- | ------------------------------------------------ |
| D√πng JDK serializer m·∫∑c ƒë·ªãnh          | Redis hi·ªÉn th·ªã nh·ªã ph√¢n, kh√≥ debug.              |
| Kh√¥ng c·∫•u h√¨nh hash serializer        | Khi l∆∞u Hash (HSET) b·ªã l·ªói ho·∫∑c deserialize sai. |
| D√πng 1 RedisTemplate cho nhi·ªÅu domain | G√¢y l·ªói class mismatch.                          |
| ƒê·ªïi class m√† kh√¥ng x√≥a cache c≈©       | L·ªói deserialize do `@class` metadata c≈©.         |
| Kh√¥ng ki·ªÉm tra encoding               | UTF-8 mismatch ‚Üí l·ªói ti·∫øng Vi·ªát.                 |

---

## üåü 11. Best Practices

‚úÖ D√πng `GenericJackson2JsonRedisSerializer` cho m·ªçi object.
‚úÖ M·ªói domain c√≥ th·ªÉ c√≥ RedisTemplate ri√™ng.
‚úÖ D√πng key prefix (`user:`, `product:`).
‚úÖ Khi thay ƒë·ªïi model ‚Üí n√™n flush cache.
‚úÖ Ki·ªÉm tra b·∫±ng RedisInsight ƒë·ªÉ xem JSON structure.
‚úÖ ƒê·∫∑t TTL khi l∆∞u th·ªß c√¥ng b·∫±ng `opsForValue().set(key, value, Duration.ofMinutes(n))`.

---

## üéì K·∫øt lu·∫≠n

B·∫°n ƒë√£ hi·ªÉu:

* C√°ch ho·∫°t ƒë·ªông c·ªßa RedisTemplate v√† serializer
* Khi n√†o d√πng JSON, String, JDK serialization
* C√°ch debug v√† tr√°nh l·ªói deserialize
* C√°ch tu·ª≥ ch·ªânh RedisTemplate theo domain
